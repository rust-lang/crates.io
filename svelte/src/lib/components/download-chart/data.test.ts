import type { DownloadChartData, Version, VersionDownload } from './data';

import { describe, expect, it } from 'vitest';

import { toChartData } from './data';

describe('toChartData()', () => {
  it('converts raw download data to Chart.js format', () => {
    let data = exampleData();
    let now = new Date('2020-12-30T12:34:56Z');
    let result = toChartData(data, now);

    expect(result).toMatchObject({
      datasets: [
        {
          backgroundColor: '#d3b5bc',
          borderColor: '#67001f',
          borderWidth: 2,
          cubicInterpolationMode: 'monotone',
          data: [
            { x: isDate('2020-12-30'), y: 30_520 },
            { x: isDate('2020-12-29'), y: 31_631 },
            { x: isDate('2020-12-28'), y: 0 },
          ],
          fill: 'origin',
          label: '1.0.56',
          pointHoverBorderWidth: 2,
          pointHoverRadius: 5,
        },
        {
          backgroundColor: '#eabdc0',
          borderColor: '#b2182b',
          borderWidth: 2,
          cubicInterpolationMode: 'monotone',
          data: [
            { x: isDate('2020-12-30'), y: 3702 },
            { x: isDate('2020-12-29'), y: 4157 },
            { x: isDate('2020-12-28'), y: 2414 },
            { x: isDate('2020-12-27'), y: 15_713 },
            { x: isDate('2020-12-26'), y: 0 },
          ],
          fill: 'origin',
          label: '1.0.55',
          pointHoverBorderWidth: 2,
          pointHoverRadius: 5,
        },
        {
          backgroundColor: '#f3d0ca',
          borderColor: '#d6604d',
          borderWidth: 2,
          cubicInterpolationMode: 'monotone',
          data: [
            { x: isDate('2020-12-30'), y: 4298 },
            { x: isDate('2020-12-29'), y: 4277 },
            { x: isDate('2020-12-28'), y: 2786 },
            { x: isDate('2020-12-27'), y: 2477 },
            { x: isDate('2020-12-26'), y: 0 },
            { x: isDate('2020-12-25'), y: 0 },
            { x: isDate('2020-12-24'), y: 0 },
            { x: isDate('2020-12-23'), y: 0 },
            { x: isDate('2020-12-22'), y: 0 },
            { x: isDate('2020-12-21'), y: 0 },
            { x: isDate('2020-12-20'), y: 0 },
            { x: isDate('2020-12-19'), y: 0 },
            { x: isDate('2020-12-18'), y: 0 },
            { x: isDate('2020-12-17'), y: 0 },
            { x: isDate('2020-12-16'), y: 0 },
            { x: isDate('2020-12-15'), y: 0 },
            { x: isDate('2020-12-14'), y: 0 },
            { x: isDate('2020-12-13'), y: 0 },
            { x: isDate('2020-12-12'), y: 0 },
            { x: isDate('2020-12-11'), y: 0 },
            { x: isDate('2020-12-10'), y: 0 },
            { x: isDate('2020-12-09'), y: 0 },
            { x: isDate('2020-12-08'), y: 0 },
            { x: isDate('2020-12-07'), y: 0 },
            { x: isDate('2020-12-06'), y: 0 },
            { x: isDate('2020-12-05'), y: 0 },
            { x: isDate('2020-12-04'), y: 0 },
            { x: isDate('2020-12-03'), y: 0 },
            { x: isDate('2020-12-02'), y: 0 },
            { x: isDate('2020-12-01'), y: 0 },
            { x: isDate('2020-11-30'), y: 0 },
            { x: isDate('2020-11-29'), y: 0 },
            { x: isDate('2020-11-28'), y: 0 },
            { x: isDate('2020-11-27'), y: 0 },
            { x: isDate('2020-11-26'), y: 0 },
            { x: isDate('2020-11-25'), y: 0 },
            { x: isDate('2020-11-24'), y: 0 },
            { x: isDate('2020-11-23'), y: 0 },
            { x: isDate('2020-11-22'), y: 0 },
            { x: isDate('2020-11-21'), y: 0 },
            { x: isDate('2020-11-20'), y: 0 },
            { x: isDate('2020-11-19'), y: 0 },
            { x: isDate('2020-11-18'), y: 0 },
            { x: isDate('2020-11-17'), y: 0 },
            { x: isDate('2020-11-16'), y: 0 },
            { x: isDate('2020-11-15'), y: 0 },
            { x: isDate('2020-11-14'), y: 0 },
          ],
          fill: 'origin',
          label: '1.0.54',
          pointHoverBorderWidth: 2,
          pointHoverRadius: 5,
        },
        {
          backgroundColor: '#fce4d9',
          borderColor: '#f4a582',
          borderWidth: 2,
          cubicInterpolationMode: 'monotone',
          data: [
            { x: isDate('2020-12-30'), y: 2228 },
            { x: isDate('2020-12-29'), y: 1650 },
            { x: isDate('2020-12-28'), y: 968 },
            { x: isDate('2020-12-27'), y: 873 },
            { x: isDate('2020-12-26'), y: 0 },
            { x: isDate('2020-12-25'), y: 0 },
            { x: isDate('2020-12-24'), y: 0 },
            { x: isDate('2020-12-23'), y: 0 },
            { x: isDate('2020-12-22'), y: 0 },
            { x: isDate('2020-12-21'), y: 0 },
            { x: isDate('2020-12-20'), y: 0 },
            { x: isDate('2020-12-19'), y: 0 },
            { x: isDate('2020-12-18'), y: 0 },
            { x: isDate('2020-12-17'), y: 0 },
            { x: isDate('2020-12-16'), y: 0 },
            { x: isDate('2020-12-15'), y: 0 },
            { x: isDate('2020-12-14'), y: 0 },
            { x: isDate('2020-12-13'), y: 0 },
            { x: isDate('2020-12-12'), y: 0 },
            { x: isDate('2020-12-11'), y: 0 },
            { x: isDate('2020-12-10'), y: 0 },
            { x: isDate('2020-12-09'), y: 0 },
            { x: isDate('2020-12-08'), y: 0 },
            { x: isDate('2020-12-07'), y: 0 },
            { x: isDate('2020-12-06'), y: 0 },
            { x: isDate('2020-12-05'), y: 0 },
            { x: isDate('2020-12-04'), y: 0 },
            { x: isDate('2020-12-03'), y: 0 },
            { x: isDate('2020-12-02'), y: 0 },
            { x: isDate('2020-12-01'), y: 0 },
            { x: isDate('2020-11-30'), y: 0 },
            { x: isDate('2020-11-29'), y: 0 },
            { x: isDate('2020-11-28'), y: 0 },
            { x: isDate('2020-11-27'), y: 0 },
            { x: isDate('2020-11-26'), y: 0 },
            { x: isDate('2020-11-25'), y: 0 },
            { x: isDate('2020-11-24'), y: 0 },
            { x: isDate('2020-11-23'), y: 0 },
            { x: isDate('2020-11-22'), y: 0 },
            { x: isDate('2020-11-21'), y: 0 },
            { x: isDate('2020-11-20'), y: 0 },
            { x: isDate('2020-11-19'), y: 0 },
            { x: isDate('2020-11-18'), y: 0 },
            { x: isDate('2020-11-17'), y: 0 },
            { x: isDate('2020-11-16'), y: 0 },
            { x: isDate('2020-11-15'), y: 0 },
            { x: isDate('2020-11-14'), y: 0 },
            { x: isDate('2020-11-13'), y: 0 },
            { x: isDate('2020-11-12'), y: 0 },
            { x: isDate('2020-11-11'), y: 0 },
            { x: isDate('2020-11-10'), y: 0 },
            { x: isDate('2020-11-09'), y: 0 },
            { x: isDate('2020-11-08'), y: 0 },
            { x: isDate('2020-11-07'), y: 0 },
            { x: isDate('2020-11-06'), y: 0 },
            { x: isDate('2020-11-05'), y: 0 },
            { x: isDate('2020-11-04'), y: 0 },
            { x: isDate('2020-11-03'), y: 0 },
            { x: isDate('2020-11-02'), y: 0 },
            { x: isDate('2020-11-01'), y: 0 },
            { x: isDate('2020-10-31'), y: 0 },
            { x: isDate('2020-10-30'), y: 0 },
            { x: isDate('2020-10-29'), y: 0 },
            { x: isDate('2020-10-28'), y: 0 },
            { x: isDate('2020-10-27'), y: 0 },
            { x: isDate('2020-10-26'), y: 0 },
            { x: isDate('2020-10-25'), y: 0 },
            { x: isDate('2020-10-24'), y: 0 },
            { x: isDate('2020-10-23'), y: 0 },
            { x: isDate('2020-10-22'), y: 0 },
            { x: isDate('2020-10-21'), y: 0 },
            { x: isDate('2020-10-20'), y: 0 },
            { x: isDate('2020-10-19'), y: 0 },
            { x: isDate('2020-10-18'), y: 0 },
            { x: isDate('2020-10-17'), y: 0 },
            { x: isDate('2020-10-16'), y: 0 },
            { x: isDate('2020-10-15'), y: 0 },
            { x: isDate('2020-10-14'), y: 0 },
            { x: isDate('2020-10-13'), y: 0 },
            { x: isDate('2020-10-12'), y: 0 },
            { x: isDate('2020-10-11'), y: 0 },
            { x: isDate('2020-10-10'), y: 0 },
            { x: isDate('2020-10-09'), y: 0 },
            { x: isDate('2020-10-08'), y: 0 },
            { x: isDate('2020-10-07'), y: 0 },
            { x: isDate('2020-10-06'), y: 0 },
            { x: isDate('2020-10-05'), y: 0 },
            { x: isDate('2020-10-04'), y: 0 },
          ],
          fill: 'origin',
          label: '1.0.53',
          pointHoverBorderWidth: 2,
          pointHoverRadius: 5,
        },
        {
          backgroundColor: '#deedf5',
          borderColor: '#92c5de',
          borderWidth: 2,
          cubicInterpolationMode: 'monotone',
          data: [
            { x: isDate('2020-12-30'), y: 201 },
            { x: isDate('2020-12-29'), y: 261 },
            { x: isDate('2020-12-28'), y: 181 },
            { x: isDate('2020-12-27'), y: 186 },
            { x: isDate('2020-12-26'), y: 0 },
            { x: isDate('2020-12-25'), y: 0 },
            { x: isDate('2020-12-24'), y: 0 },
            { x: isDate('2020-12-23'), y: 0 },
            { x: isDate('2020-12-22'), y: 0 },
            { x: isDate('2020-12-21'), y: 0 },
            { x: isDate('2020-12-20'), y: 0 },
            { x: isDate('2020-12-19'), y: 0 },
            { x: isDate('2020-12-18'), y: 0 },
            { x: isDate('2020-12-17'), y: 0 },
            { x: isDate('2020-12-16'), y: 0 },
            { x: isDate('2020-12-15'), y: 0 },
            { x: isDate('2020-12-14'), y: 0 },
            { x: isDate('2020-12-13'), y: 0 },
            { x: isDate('2020-12-12'), y: 0 },
            { x: isDate('2020-12-11'), y: 0 },
            { x: isDate('2020-12-10'), y: 0 },
            { x: isDate('2020-12-09'), y: 0 },
            { x: isDate('2020-12-08'), y: 0 },
            { x: isDate('2020-12-07'), y: 0 },
            { x: isDate('2020-12-06'), y: 0 },
            { x: isDate('2020-12-05'), y: 0 },
            { x: isDate('2020-12-04'), y: 0 },
            { x: isDate('2020-12-03'), y: 0 },
            { x: isDate('2020-12-02'), y: 0 },
            { x: isDate('2020-12-01'), y: 0 },
            { x: isDate('2020-11-30'), y: 0 },
            { x: isDate('2020-11-29'), y: 0 },
            { x: isDate('2020-11-28'), y: 0 },
            { x: isDate('2020-11-27'), y: 0 },
            { x: isDate('2020-11-26'), y: 0 },
            { x: isDate('2020-11-25'), y: 0 },
            { x: isDate('2020-11-24'), y: 0 },
            { x: isDate('2020-11-23'), y: 0 },
            { x: isDate('2020-11-22'), y: 0 },
            { x: isDate('2020-11-21'), y: 0 },
            { x: isDate('2020-11-20'), y: 0 },
            { x: isDate('2020-11-19'), y: 0 },
            { x: isDate('2020-11-18'), y: 0 },
            { x: isDate('2020-11-17'), y: 0 },
            { x: isDate('2020-11-16'), y: 0 },
            { x: isDate('2020-11-15'), y: 0 },
            { x: isDate('2020-11-14'), y: 0 },
            { x: isDate('2020-11-13'), y: 0 },
            { x: isDate('2020-11-12'), y: 0 },
            { x: isDate('2020-11-11'), y: 0 },
            { x: isDate('2020-11-10'), y: 0 },
            { x: isDate('2020-11-09'), y: 0 },
            { x: isDate('2020-11-08'), y: 0 },
            { x: isDate('2020-11-07'), y: 0 },
            { x: isDate('2020-11-06'), y: 0 },
            { x: isDate('2020-11-05'), y: 0 },
            { x: isDate('2020-11-04'), y: 0 },
            { x: isDate('2020-11-03'), y: 0 },
            { x: isDate('2020-11-02'), y: 0 },
            { x: isDate('2020-11-01'), y: 0 },
            { x: isDate('2020-10-31'), y: 0 },
            { x: isDate('2020-10-30'), y: 0 },
            { x: isDate('2020-10-29'), y: 0 },
            { x: isDate('2020-10-28'), y: 0 },
            { x: isDate('2020-10-27'), y: 0 },
            { x: isDate('2020-10-26'), y: 0 },
            { x: isDate('2020-10-25'), y: 0 },
            { x: isDate('2020-10-24'), y: 0 },
            { x: isDate('2020-10-23'), y: 0 },
            { x: isDate('2020-10-22'), y: 0 },
            { x: isDate('2020-10-21'), y: 0 },
            { x: isDate('2020-10-20'), y: 0 },
            { x: isDate('2020-10-19'), y: 0 },
            { x: isDate('2020-10-18'), y: 0 },
            { x: isDate('2020-10-17'), y: 0 },
            { x: isDate('2020-10-16'), y: 0 },
            { x: isDate('2020-10-15'), y: 0 },
            { x: isDate('2020-10-14'), y: 0 },
            { x: isDate('2020-10-13'), y: 0 },
            { x: isDate('2020-10-12'), y: 0 },
            { x: isDate('2020-10-11'), y: 0 },
            { x: isDate('2020-10-10'), y: 0 },
            { x: isDate('2020-10-09'), y: 0 },
            { x: isDate('2020-10-08'), y: 0 },
            { x: isDate('2020-10-07'), y: 0 },
            { x: isDate('2020-10-06'), y: 0 },
            { x: isDate('2020-10-05'), y: 0 },
            { x: isDate('2020-10-04'), y: 0 },
            { x: isDate('2020-10-03'), y: 0 },
            { x: isDate('2020-10-02'), y: 0 },
          ],
          fill: 'origin',
          label: '1.0.52',
          pointHoverBorderWidth: 2,
          pointHoverRadius: 5,
        },
        {
          backgroundColor: '#c9deed',
          borderColor: '#4393c3',
          borderWidth: 2,
          cubicInterpolationMode: 'monotone',
          data: [
            { x: isDate('2020-12-30'), y: 36_745 },
            { x: isDate('2020-12-29'), y: 33_242 },
            { x: isDate('2020-12-28'), y: 19_981 },
            { x: isDate('2020-12-27'), y: 19_064 },
            { x: isDate('2020-12-26'), y: 0 },
            { x: isDate('2020-12-25'), y: 0 },
            { x: isDate('2020-12-24'), y: 0 },
            { x: isDate('2020-12-23'), y: 0 },
            { x: isDate('2020-12-22'), y: 0 },
            { x: isDate('2020-12-21'), y: 0 },
            { x: isDate('2020-12-20'), y: 0 },
            { x: isDate('2020-12-19'), y: 0 },
            { x: isDate('2020-12-18'), y: 0 },
            { x: isDate('2020-12-17'), y: 0 },
            { x: isDate('2020-12-16'), y: 0 },
            { x: isDate('2020-12-15'), y: 0 },
            { x: isDate('2020-12-14'), y: 0 },
            { x: isDate('2020-12-13'), y: 0 },
            { x: isDate('2020-12-12'), y: 0 },
            { x: isDate('2020-12-11'), y: 0 },
            { x: isDate('2020-12-10'), y: 0 },
            { x: isDate('2020-12-09'), y: 0 },
            { x: isDate('2020-12-08'), y: 0 },
            { x: isDate('2020-12-07'), y: 0 },
            { x: isDate('2020-12-06'), y: 0 },
            { x: isDate('2020-12-05'), y: 0 },
            { x: isDate('2020-12-04'), y: 0 },
            { x: isDate('2020-12-03'), y: 0 },
            { x: isDate('2020-12-02'), y: 0 },
            { x: isDate('2020-12-01'), y: 0 },
            { x: isDate('2020-11-30'), y: 0 },
            { x: isDate('2020-11-29'), y: 0 },
            { x: isDate('2020-11-28'), y: 0 },
            { x: isDate('2020-11-27'), y: 0 },
            { x: isDate('2020-11-26'), y: 0 },
            { x: isDate('2020-11-25'), y: 0 },
            { x: isDate('2020-11-24'), y: 0 },
            { x: isDate('2020-11-23'), y: 0 },
            { x: isDate('2020-11-22'), y: 0 },
            { x: isDate('2020-11-21'), y: 0 },
            { x: isDate('2020-11-20'), y: 0 },
            { x: isDate('2020-11-19'), y: 0 },
            { x: isDate('2020-11-18'), y: 0 },
            { x: isDate('2020-11-17'), y: 0 },
            { x: isDate('2020-11-16'), y: 0 },
            { x: isDate('2020-11-15'), y: 0 },
            { x: isDate('2020-11-14'), y: 0 },
            { x: isDate('2020-11-13'), y: 0 },
            { x: isDate('2020-11-12'), y: 0 },
            { x: isDate('2020-11-11'), y: 0 },
            { x: isDate('2020-11-10'), y: 0 },
            { x: isDate('2020-11-09'), y: 0 },
            { x: isDate('2020-11-08'), y: 0 },
            { x: isDate('2020-11-07'), y: 0 },
            { x: isDate('2020-11-06'), y: 0 },
            { x: isDate('2020-11-05'), y: 0 },
            { x: isDate('2020-11-04'), y: 0 },
            { x: isDate('2020-11-03'), y: 0 },
            { x: isDate('2020-11-02'), y: 0 },
            { x: isDate('2020-11-01'), y: 0 },
            { x: isDate('2020-10-31'), y: 0 },
            { x: isDate('2020-10-30'), y: 0 },
            { x: isDate('2020-10-29'), y: 0 },
            { x: isDate('2020-10-28'), y: 0 },
            { x: isDate('2020-10-27'), y: 0 },
            { x: isDate('2020-10-26'), y: 0 },
            { x: isDate('2020-10-25'), y: 0 },
            { x: isDate('2020-10-24'), y: 0 },
            { x: isDate('2020-10-23'), y: 0 },
            { x: isDate('2020-10-22'), y: 0 },
            { x: isDate('2020-10-21'), y: 0 },
            { x: isDate('2020-10-20'), y: 0 },
            { x: isDate('2020-10-19'), y: 0 },
            { x: isDate('2020-10-18'), y: 0 },
            { x: isDate('2020-10-17'), y: 0 },
            { x: isDate('2020-10-16'), y: 0 },
            { x: isDate('2020-10-15'), y: 0 },
            { x: isDate('2020-10-14'), y: 0 },
            { x: isDate('2020-10-13'), y: 0 },
            { x: isDate('2020-10-12'), y: 0 },
            { x: isDate('2020-10-11'), y: 0 },
            { x: isDate('2020-10-10'), y: 0 },
            { x: isDate('2020-10-09'), y: 0 },
            { x: isDate('2020-10-08'), y: 0 },
            { x: isDate('2020-10-07'), y: 0 },
            { x: isDate('2020-10-06'), y: 0 },
            { x: isDate('2020-10-05'), y: 0 },
            { x: isDate('2020-10-04'), y: 0 },
            { x: isDate('2020-10-03'), y: 0 },
            { x: isDate('2020-10-02'), y: 0 },
          ],
          fill: 'origin',
          label: 'Other',
          pointHoverBorderWidth: 2,
          pointHoverRadius: 5,
        },
      ],
    });
  });
});

function exampleData(): DownloadChartData {
  let versions: Version[] = [
    createVersion(52, '1.0.52', '2020-10-01'),
    createVersion(53, '1.0.53', '2020-10-05'),
    createVersion(54, '1.0.54', '2020-11-15'),
    createVersion(55, '1.0.55', '2020-12-27'),
    createVersion(56, '1.0.56', '2020-12-29'),
  ];

  let versionDownloads: VersionDownload[] = [
    { version: 52, date: '2020-12-30', downloads: 201 },
    { version: 53, date: '2020-12-30', downloads: 2228 },
    { version: 54, date: '2020-12-30', downloads: 4298 },
    { version: 55, date: '2020-12-30', downloads: 3702 },
    { version: 56, date: '2020-12-30', downloads: 30_520 },
    { version: 52, date: '2020-12-29', downloads: 261 },
    { version: 53, date: '2020-12-29', downloads: 1650 },
    { version: 54, date: '2020-12-29', downloads: 4277 },
    { version: 55, date: '2020-12-29', downloads: 4157 },
    { version: 56, date: '2020-12-29', downloads: 31_631 },
    { version: 52, date: '2020-12-28', downloads: 181 },
    { version: 53, date: '2020-12-28', downloads: 968 },
    { version: 54, date: '2020-12-28', downloads: 2786 },
    { version: 55, date: '2020-12-28', downloads: 2414 },
    { version: 52, date: '2020-12-27', downloads: 186 },
    { version: 53, date: '2020-12-27', downloads: 873 },
    { version: 54, date: '2020-12-27', downloads: 2477 },
    { version: 55, date: '2020-12-27', downloads: 15_713 },
  ];

  let extraDownloads = [
    { date: '2020-12-30', downloads: 36_745 },
    { date: '2020-12-29', downloads: 33_242 },
    { date: '2020-12-28', downloads: 19_981 },
    { date: '2020-12-27', downloads: 19_064 },
  ];

  return { versionDownloads, extraDownloads, versions };
}

function createVersion(id: number, num: string, createdAt: string): Version {
  return {
    id,
    num,
    audit_actions: [],
    checksum: 'abc123',
    created_at: createdAt,
    crate: 'test-crate',
    crate_size: 1000,
    dl_path: `/api/v1/crates/test-crate/${num}/download`,
    downloads: 0,
    features: {},
    license: 'MIT',
    linecounts: {},
    links: {
      authors: '',
      dependencies: '',
      version_downloads: '',
    },
    published_by: null,
    readme_path: `/api/v1/crates/test-crate/${num}/readme`,
    updated_at: createdAt,
    yanked: false,
  };
}

function isDate(isoDate: string) {
  return {
    asymmetricMatch: (date: Date) => date.toISOString().startsWith(isoDate),
  };
}
